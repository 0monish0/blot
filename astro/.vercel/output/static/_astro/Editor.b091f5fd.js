import{F as se,T as Z,p as w,h as A,_ as Q}from"./hooks.module.81959310.js";import{u as ae,g as b,o as n,c as ee,B as p,a as L,r as O,p as E,m as ce,l as te,b as le,d as Y,T as U,e as ne,s as de,j as he,E as ue,f as N,t as ge,h as re,i as fe,k as we,n as pe,v as me,q as ve}from"./state.84f5a575.js";import{s as I,a as M,b as m,c as y,d as v,e as ye,f as P}from"./editor.19beca6a.a6416c6a.js";import{k as D}from"./preact.module.5538535e.js";const ke=()=>{const{view:e}=b(),t=e.state.doc.toString();localStorage.setItem("cache",t)};function xe(){return ae(ke,[]),null}let be=(e=21)=>crypto.getRandomValues(new Uint8Array(e)).reduce((t,r)=>(r&=63,r<36?t+=r.toString(36):r<62?t+=(r-26).toString(36).toUpperCase():r>62?t+="-":t+="_",t),"");function Ce({show:e,className:t,title:r,children:i,actions:o,close:s}){const a=se(()=>be(),[]),l=Z(()=>{s()},[]);return w(()=>(e?window.addEventListener("keydown",l):window.removeEventListener("keydown",l),()=>{window.removeEventListener("keydown",l)}),[e,l]),e?n("div",{class:ee(I.root,t),onKeyDown:c=>{c.key==="Escape"&&s()},onClickCapture:c=>{c.target===c.currentTarget&&s()},children:n("div",{role:"dialog","aria-labelledby":a+"-label","aria-describedby":a+"-desc",class:I.box,children:[n("h2",{id:a+"-label",children:r}),n("p",{id:a+"-desc",children:i}),n("div",{class:I.actions,children:o})]})}):null}function Le(){const[e,t]=A(!1);return w(()=>{},[]),n(Ce,{show:e,title:"Incompatible browser",actions:n(p,{onClick:()=>t(!1),children:"Continue"}),close:()=>t(!1),children:"Your browser doesn't seem to support the Web Serial API, which is required for the editor to be able to connect to hardware. You can still use the site to write code, but for full functionality, use Chrome or Edge version 89 or above."})}function Se(e){return n("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 32 32",className:e.className,children:[n("polygon",{points:"8 2 2 2 2 8 4 8 4 4 8 4 8 2"}),n("polygon",{points:"24 2 30 2 30 8 28 8 28 4 24 4 24 2"}),n("polygon",{points:"8 30 2 30 2 24 4 24 4 28 8 28 8 30"}),n("polygon",{points:"24 30 30 30 30 24 28 24 28 28 24 28 24 30"}),n("path",{d:"M24,24H8a2.0023,2.0023,0,0,1-2-2V10A2.0023,2.0023,0,0,1,8,8H24a2.0023,2.0023,0,0,1,2,2V22A2.0023,2.0023,0,0,1,24,24ZM8,10V22H24V10Z"})]})}function Ee(e,t){let r=e.length,i=V(e[0],t),o=[],s,a,l,c,h;const d=[];for(s=1;s<r;s++){for(a=e[s-1],l=e[s],c=h=V(l,t);;)if(i|c){if(i&c)break;i?(a=X(a,l,i,t),i=V(a,t)):(l=X(a,l,c,t),c=V(l,t))}else{o.push(a),c!==h?(o.push(l),s<r-1&&(d.push(o),o=[])):s===r-1&&o.push(l);break}i=h}return o.length&&d.push(o),d}function X(e,t,r,i){return r&8?[e[0]+(t[0]-e[0])*(i[3]-e[1])/(t[1]-e[1]),i[3]]:r&4?[e[0]+(t[0]-e[0])*(i[1]-e[1])/(t[1]-e[1]),i[1]]:r&2?[i[2],e[1]+(t[1]-e[1])*(i[2]-e[0])/(t[0]-e[0])]:r&1?[i[0],e[1]+(t[1]-e[1])*(i[0]-e[0])/(t[0]-e[0])]:null}function V(e,t){let r=0;return e[0]<t[0]?r|=1:e[0]>t[2]&&(r|=2),e[1]<t[1]?r|=4:e[1]>t[3]&&(r|=8),r}function $e(e){return e.composedPath()[0]}function Be(e,t){return $e(e).matches(t)}function R(e){return(t,r,i,o={})=>{e.addEventListener(t,s=>{(r===""||Be(s,r))&&i(s)},o)}}function Ae(e){const{turtles:t,docDimensions:r}=L(["turtles","docDimensions"]);return w(De,[]),w(()=>{const i=document.querySelector(".main-canvas");B(i)},[t,r]),n("div",{class:M.root,children:[n("canvas",{class:`${M.canvas} ${e.className} main-canvas`}),n("div",{class:`${M.mousePosition} mouse-position`}),n(p,{class:`${M.centerButton} center-view-trigger`,variant:"ghost",icon:!0,"aria-label":"center document in view",children:n(Se,{})})]})}function De(){const e=document.querySelector(".main-canvas"),t=R(document.body),r=R(e);r("wheel","",o=>{o.preventDefault();const s=5e-4,{panX:a,panY:l,scale:c}=g,h=c+c*(-o.deltaY*s),d=e.getBoundingClientRect(),u={x:o.clientX-d.left,y:o.clientY-d.top};g.panX=u.x+h/c*(a-u.x),g.panY=u.y+h/c*(l-u.y),g.scale=h,B(e)},{passive:!1}),r("mousemove","",o=>{const s=document.querySelector(".mouse-position");if(s){const{panX:a,panY:l,scale:c}=g,h=e.getBoundingClientRect();let d=o.clientX-h.left;d=(d-a)/c;let u=o.clientY-h.top;u=(u-l)/c;const f=k=>k.startsWith("-")?k:" "+k;s.textContent=`${f(d.toFixed(1))}mm, ${f(u.toFixed(1))}mm`}o.buttons===1&&(o.preventDefault(),g.panX+=o.movementX,g.panY+=o.movementY,B(e))}),t("click","",o=>{if(!o.target.closest(".center-view-trigger"))return;const{docDimensions:s}=b();if(!e)return;const a=e.getBoundingClientRect();g.scale=Math.min((a.width-20)/s.width,(a.height-20)/s.height),g.panX=a.width/2-s.width*g.scale/2,g.panY=a.height/2+s.height*g.scale/2,B(e)}),new ResizeObserver(o=>{const{width:s,height:a}=o[0].contentRect;x=window.devicePixelRatio||1,e.width=s*x,e.height=a*x,ie(),B(e)}).observe(e)}const g={panX:200,panY:200,scale:100};let x=typeof window>"u"?1:window.devicePixelRatio||1;const B=e=>{requestAnimationFrame(()=>{Me(e)})};let C=null;const ie=()=>{C&&(C.lineWidth=1,C.lineJoin="round",C.lineCap="round")},Te=e=>(C||(C=e.getContext("2d"),ie()),C),Me=e=>{const{turtlePos:t,turtles:r,docDimensions:{width:i,height:o}}=b();if(!e||!t)return;const s=e.width,a=e.height,l=Te(e);l.clearRect(0,0,s,a),l.strokeStyle="#3333ee",l.strokeRect(x*g.panX,x*g.panY,x*i*g.scale,-x*o*g.scale),l.strokeStyle="black";const{panX:c,panY:h,scale:d}=g;l.beginPath();for(const u of r)for(const f of u.path){const k=f.map(([T,S])=>[x*(c+T*d),-(x*(-h+S*d))]);Ee(k,[0,0,s,a]).forEach(T=>{for(let S=0;S<T.length;S++){let[j,W]=T[S];S===0?l.moveTo(j,W):l.lineTo(j,W)}})}l.stroke()};function oe(e,t){const r=new Blob([t],{type:"text/plain"}),i=document.createElement("a");i.href=URL.createObjectURL(r),i.download=`${e}`,i.click(),URL.revokeObjectURL(i.href)}function Pe(e){return n("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 32 32",className:e.className,children:[n("rect",{x:"15",y:"2",width:"2",height:"3"}),n("rect",{x:"27",y:"15",width:"3",height:"2"}),n("rect",{x:"15",y:"27",width:"2",height:"3"}),n("rect",{x:"2",y:"15",width:"3",height:"2"}),n("rect",{x:"6.22",y:"5.73",width:"2",height:"3",transform:"translate(-3 7.23) rotate(-45)"}),n("rect",{x:"23.27",y:"6.23",width:"3",height:"2",transform:"translate(2.14 19.63) rotate(-45)"}),n("rect",{x:"23.77",y:"23.27",width:"2",height:"3",transform:"translate(-10.26 24.77) rotate(-45)"}),n("polygon",{points:"5.47 25.13 7.59 23 9 24.42 6.88 26.54 5.47 25.13"}),n("path",{d:"M16,8a8,8,0,1,0,8,8A8,8,0,0,0,16,8Zm0,14a6,6,0,0,1,0-12Z"})]})}function Ve(e){return n("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 32 32",className:e.className,children:[n("path",{d:"M27,16.76c0-.25,0-.5,0-.76s0-.51,0-.77l1.92-1.68A2,2,0,0,0,29.3,11L26.94,7a2,2,0,0,0-1.73-1,2,2,0,0,0-.64.1l-2.43.82a11.35,11.35,0,0,0-1.31-.75l-.51-2.52a2,2,0,0,0-2-1.61H13.64a2,2,0,0,0-2,1.61l-.51,2.52a11.48,11.48,0,0,0-1.32.75L7.43,6.06A2,2,0,0,0,6.79,6,2,2,0,0,0,5.06,7L2.7,11a2,2,0,0,0,.41,2.51L5,15.24c0,.25,0,.5,0,.76s0,.51,0,.77L3.11,18.45A2,2,0,0,0,2.7,21L5.06,25a2,2,0,0,0,1.73,1,2,2,0,0,0,.64-.1l2.43-.82a11.35,11.35,0,0,0,1.31.75l.51,2.52a2,2,0,0,0,2,1.61h4.72a2,2,0,0,0,2-1.61l.51-2.52a11.48,11.48,0,0,0,1.32-.75l2.42.82a2,2,0,0,0,.64.1,2,2,0,0,0,1.73-1L29.3,21a2,2,0,0,0-.41-2.51ZM25.21,24l-3.43-1.16a8.86,8.86,0,0,1-2.71,1.57L18.36,28H13.64l-.71-3.55a9.36,9.36,0,0,1-2.7-1.57L6.79,24,4.43,20l2.72-2.4a8.9,8.9,0,0,1,0-3.13L4.43,12,6.79,8l3.43,1.16a8.86,8.86,0,0,1,2.71-1.57L13.64,4h4.72l.71,3.55a9.36,9.36,0,0,1,2.7,1.57L25.21,8,27.57,12l-2.72,2.4a8.9,8.9,0,0,1,0,3.13L27.57,20Z",transform:"translate(0 0)"}),n("path",{d:"M16,22a6,6,0,1,1,6-6A5.94,5.94,0,0,1,16,22Zm0-10a3.91,3.91,0,0,0-4,4,3.91,3.91,0,0,0,4,4,3.91,3.91,0,0,0,4-4A3.91,3.91,0,0,0,16,12Z",transform:"translate(0 0)"})]})}function He(e){return n("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 32 32",className:e.className,children:[n("path",{d:"M28,26H4a2,2,0,0,1-2-2V10A2,2,0,0,1,4,8H28a2,2,0,0,1,2,2V24A2,2,0,0,1,28,26ZM4,10V24H28V10Z"}),n("rect",{x:"10",y:"20",width:"11",height:"2"}),n("rect",{x:"6",y:"12",width:"2",height:"2"}),n("rect",{x:"10",y:"12",width:"2",height:"2"}),n("rect",{x:"14",y:"12",width:"2",height:"2"}),n("rect",{x:"18",y:"12",width:"2",height:"2"}),n("rect",{x:"6",y:"20",width:"2",height:"2"}),n("rect",{x:"6",y:"16",width:"2",height:"2"}),n("rect",{x:"10",y:"16",width:"2",height:"2"}),n("rect",{x:"14",y:"16",width:"2",height:"2"}),n("rect",{x:"22",y:"12",width:"4",height:"2"}),n("rect",{x:"22",y:"16",width:"4",height:"2"}),n("rect",{x:"18",y:"16",width:"2",height:"2"}),n("rect",{x:"23",y:"20",width:"3",height:"2"})]})}function Ne(e){return n("svg",{className:e.className,id:"icon",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 32 32",children:n("path",{class:"cls-1",d:"M16,2a14,14,0,0,0-4.43,27.28c.7.13,1-.3,1-.67s0-1.21,0-2.38c-3.89.84-4.71-1.88-4.71-1.88A3.71,3.71,0,0,0,6.24,22.3c-1.27-.86.1-.85.1-.85A2.94,2.94,0,0,1,8.48,22.9a3,3,0,0,0,4.08,1.16,2.93,2.93,0,0,1,.88-1.87c-3.1-.36-6.37-1.56-6.37-6.92a5.4,5.4,0,0,1,1.44-3.76,5,5,0,0,1,.14-3.7s1.17-.38,3.85,1.43a13.3,13.3,0,0,1,7,0c2.67-1.81,3.84-1.43,3.84-1.43a5,5,0,0,1,.14,3.7,5.4,5.4,0,0,1,1.44,3.76c0,5.38-3.27,6.56-6.39,6.91a3.33,3.33,0,0,1,.95,2.59c0,1.87,0,3.38,0,3.84s.25.81,1,.67A14,14,0,0,0,16,2Z"})})}function Re(){const{connected:e}=L(["connected"]),[t,r]=A(!0);return n("div",{class:m.root,children:[n("div",{style:{display:"flex","align-items":"center"},children:[n("h1",{class:m.heading,children:"Blot"}),n(Ie,{}),n(Ze,{}),n(Ye,{}),n("div",{style:{position:"relative",cursor:"default",width:"min-width"},onMouseEnter:()=>r(!1),onMouseLeave:()=>r(!0),children:[n("div",{style:{padding:"5px"},children:"download"}),n("div",{style:{display:t?"none":"",position:"absolute",background:"var(--primary)","z-index":9999,width:"100%",top:"100%",padding:"5px","border-radius":"5px"},children:[n(Oe,{}),n(je,{}),n(We,{})]})]})]}),n("div",{style:{display:"flex","align-items":"center"},children:[n(p,{variant:"ghost",class:"connect-trigger",children:[e?"disconnect from":"connect to"," machine"]}),e&&n(p,{variant:"ghost",class:"run-machine-trigger",children:"run machine"}),n(Ue,{}),n(Xe,{})]})]})}function Ue(){return n(p,{variant:"ghost",children:n("a",{style:{all:"unset"},href:"https://github.com/hackclub/haxidraw/tree/main",target:"_blank",children:n("div",{style:{transform:"translate(0, 3.5px)"},children:n(Ne,{className:m.icon})})})})}function Ie(){return w(()=>{async function e(t){t.shiftKey&&t.key==="Enter"&&(t.preventDefault(),t.stopPropagation(),await O())}return window.addEventListener("keydown",e),()=>{window.removeEventListener("keydown",e)}},[]),n(p,{variant:"ghost",onClick:()=>{alert(JSON.stringify(b().turtles[0])),O()},children:"run (shift+enter)"})}function Oe(){const e=L();return n("div",{class:m.dropdownEntry,onClick:()=>oe("project.js",e.code.content),children:"js"})}function Ze(){return n(p,{variant:"ghost",onClick:()=>{E({...ce()})},children:"new"})}function je(){return n("div",{class:m.dropdownEntry,onClick:()=>{const{turtles:e,docDimensions:t}=b(),r=a=>{let l="";return a.path.forEach(c=>c.forEach((h,d)=>{const[u,f]=h;d===0?l+=`M ${u} ${f}`:l+=`L ${u} ${f}`})),l},i=a=>`<path 
                    d="${r(a)}" 
                    stroke-width="0.25" 
                    stroke="black" 
                    fill="none" 
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    style="transform: scale(1, 1);"
                    />`,o=e.map(i),s=`
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 ${t.width} ${t.height}" width="${t.width}mm" height="${t.height}mm">
                    ${o.join(`
`)}
                </svg>
            `;oe("anon.svg",s)},children:"svg"})}function We(){return n("div",{class:m.dropdownEntry,onClick:()=>{const{turtles:e,docDimensions:t}=b(),r=c=>{let h="";return c.path.forEach(d=>d.forEach((u,f)=>{const[k,$]=u;f===0?h+=`M ${k} ${$}`:h+=`L ${k} ${$}`})),h},i=c=>`<path 
                    d="${r(c)}" 
                    stroke-width="0.25" 
                    stroke="black" 
                    fill="none" 
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    style="transform: scale(1, 1);"
                    />`,o=e.map(i),s=`
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 ${t.width} ${t.height}" width="${t.width}mm" height="${t.height}mm">
                    ${o.join(`
`)}
                </svg>
            `,a=new Image;a.onload=function(){const c=document.createElement("canvas");c.width=a.width,c.height=a.height,c.getContext("2d").drawImage(a,0,0);const d=c.toDataURL("image/png"),u=document.createElement("a");u.href=d,u.download="image.png",u.textContent="Download PNG",u.click()};const l="data:image/svg+xml;charset=utf-8,"+encodeURIComponent(s);a.src=l},children:"png"})}function Ye(){return n(p,{variant:"ghost",onClick:()=>{const e=document.createElement("input");e.type="file",e.accept=".js",e.onchange=()=>{if(e.files?.length){const t=e.files[0],r=new FileReader;r.onload=()=>{typeof r.result=="string"&&te(r.result)},r.readAsText(t)}},e.click()},children:"open"})}function Xe(){const{theme:e,vimMode:t}=le(["theme","vimMode"]),[r,i]=A(!1);return w(()=>{if(!r)return;function o(s){s.target.closest(`.${m.settingsWrapper}`)||i(!1)}return window.addEventListener("click",o),()=>{window.removeEventListener("click",o)}},[r]),n("div",{class:m.settingsWrapper,children:[n(p,{variant:"ghost",icon:!0,"aria-label":"show settings menu","aria-expanded":r,onClick:()=>{i(!r)},children:n(Ve,{})}),r&&n("div",{class:m.settingsDropdown,children:[n(p,{variant:"ghost",onClick:()=>{Y({theme:e===U.Dark?U.Light:U.Dark}),i(!1)},children:[n(Pe,{className:m.icon}),n("span",{children:"toggle theme"})]}),n(p,{variant:"ghost",onClick:()=>{Y({vimMode:!t}),i(!1)},children:[n(He,{className:m.icon}),n("span",{children:[t?"disable":"enable"," vim mode"]})]})]})]})}function Fe(e){return n("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 32 32",className:e.className,children:n("path",{d:"M13.4141,17.5859,18,22.1719V8H8V6H18a2.0024,2.0024,0,0,1,2,2V22.1719l4.5859-4.586L26,19l-7,7-7-7Z"})})}const F=({pos:e,code:t,message:r})=>{const i=Q();ne(i.current);const o=Z(c=>{if(!c)return;c.children[0]&&c.children[0]&&c.children[0].view.destroy();const h=[de(fe,{fallback:!0}),he(),ue.readOnly.of(!0),N.editable.of(!1),N.theme({".cm-content":{padding:"0"},".cm-line":{padding:"0"},".cm-scroller":{fontFamily:"inherit",lineHeight:"inherit"},".ͼp":{backgroundColor:"transparent"}}),ge()],d=new N({doc:t.split(`
`)[e.line-1],parent:c,extensions:h});c.children[0].view=d,i.current=d},[t]);w(()=>{i.current&&i.current.dispatch({changes:{from:0,to:i.current.state.doc.length,insert:t.split(`
`)[e.line-1]}})},[t]);const s=e.line!==1,a=t.split(`
`),l=s?a[e.line-2].trimStart():void 0;return n("pre",{class:y.snippet,children:[n("div",{children:[s&&n("div",{children:e.line-1}),n("div",{children:e.line})]}),n("code",{children:[s&&n(D,{children:[" ".repeat(a[e.line-2].length-l.length),n("span",{class:y.context,children:l})]}),n("div",{ref:o,class:y.cm})," ".repeat(e.column),n("span",{class:y.arrow,children:"↑"}),r&&n("span",{class:y.message,children:r})]}),n("button",{class:y.jumpTo,onClick:()=>re(e),children:[n(Fe,{}),"Jump to line"]})]})};function qe(){const{error:e}=L(["error"]);if(!e)return null;const t=e.stack?.[0]?.line;return n("div",{class:y.root,children:[n("span",{class:y.name,children:e.name}),t!=null?n(F,{pos:e.stack[0],code:e.code,message:e.message}):n(D,{children:[n("span",{children:e.message}),n("span",{children:"something went wrong getting the error snippet. report this as a bug on GitHub."})]}),e.stack.length>1&&n("details",{children:[n("summary",{class:y.stackLabel,children:"stack trace"}),n("div",{class:y.stack,children:e.stack.slice(1).map((r,i)=>n(F,{pos:r,code:e.code,message:"in this call"},i))})]})]})}function Ge(e){return n("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 32 32",className:e.className,children:[n("rect",{x:"12",y:"12",width:"2",height:"12"}),n("rect",{x:"18",y:"12",width:"2",height:"12"}),n("path",{d:"M4,6V8H6V28a2,2,0,0,0,2,2H24a2,2,0,0,0,2-2V8h2V6ZM8,28V8H24V28Z"})]})}function Je(){const{console:e}=L(["console"]),t=Q(null);return w(()=>{t.current&&(t.current.scrollTop=t.current.scrollHeight)},[e]),e.length===0?null:n("div",{class:v.root,children:[n("div",{class:v.header,children:[n("span",{children:"console"}),n(p,{class:v.clearButton,variant:"ghost",icon:!0,"aria-label":"clear",onClick:()=>E({console:[]}),children:n(Ge,{})})]}),n("div",{class:v.lines,ref:t,children:e.map(({type:r,time:i,values:o,pos:s},a)=>n("div",{class:ee(v.line,r==="warn"?v.tWarn:r==="error"&&v.tError),children:[n("div",{class:v.time,children:new Date(i).toLocaleTimeString()}),n("div",{class:v.values,children:o.map((l,c)=>n("div",{children:typeof l=="string"?l:JSON.stringify(l)},c))}),s&&n("button",{class:v.pos,onClick:()=>{re(s)},children:[":",s.line,":",s.column]})]},`${i},${a}`))})]})}function _e(){const e=L();return w(()=>{globalThis._globalState=e},[e]),null}function ze(){return w(()=>{Ke()},[]),n(D,{children:[n("style",{children:`
            .drop {
                position: absolute;
                width: 100%;
                height: 100%;
                background: lightblue;
                opacity: .8;
                align-items: center;
                justify-content: center;
                border: 3px dashed grey;
                left: 0px;
                top: 0px;
                display: flex;
            }

            .hidden {
                display: none;
            }
        `}),n("div",{class:"drop hidden droparea",children:"Drop an SVG or JS file."})]})}function Ke(){const e=document.querySelector(".droparea");window.addEventListener("drop",function(t){const{view:r}=b();let i=t.dataTransfer;if(i===null||e===null)return;let o=i.files;e.classList.add("hidden");const s=o[0],a=s.name.split(".");a[0];const l=a[a.length-1];var c=new FileReader;c.readAsText(s),c.onloadend=h=>{let d=c.result;if(l==="js")te(d);else if(l==="svg"){d=d.replaceAll(`
`,"");const u=`const importedSVG = new Turtle().fromSVG(String.raw\`${d}\`);
`;r.dispatch({changes:{from:0,insert:u}})}else throw Error("Unknown extension:"+l)},q(t)}),window.addEventListener("dragover",function(t){e.classList.remove("hidden"),q(t)}),["mouseout"].forEach(t=>window.addEventListener(t,function(r){e.classList.add("hidden")}))}function q(e){return e.stopPropagation&&e.stopPropagation(),e.preventDefault&&e.preventDefault(),e.cancelBubble=!0,e.returnValue=!1,!1}function Qe(){const{code:e,error:t}=L(["code","error"]),[r,i]=A();w(()=>{r&&r.setState(e.cmState)},[r,e]),w(()=>{E({view:r})},[r]),ne(r),we(r),pe(s=>{r&&me(s,r)},[r]),w(()=>{if(!r)return;const s=t?.stack[0].line;ve(r,s?r.state.doc.line(s).from:null)},[t]);const o=Z(s=>{if(!s)return;const a=new N({parent:s});s.children[0].view=a,i(a)},[]);return n(D,{children:n("div",{class:ye.cmWrapper,ref:o})})}async function et(e,t=115200){const r=[];await e.open({baudRate:t});let i=null,o=null;async function s(){try{for(;e.readable;)for(i=e.readable.getReader();;){const{value:l,done:c}=await i.read();if(l)for(let h=0;h<l.length;h++)r.push(l[h]);if(c){i.releaseLock(),i=null;break}}}catch(l){console.error(l)}finally{}}s();async function a(l){o=e.writable.getWriter(),await o.write(l),o.releaseLock(),o=null}return{write:a,read:()=>r.length>0?r.shift():null,available:()=>r.length>0,close:async()=>{i&&i.releaseLock(),o&&o.releaseLock(),await e.close()}}}function G(e){var t=[0],r=0,i=1;function o(a){t[r]=i,r=t.length,a!==!1&&t.push(0),i=1}for(var s=0;s<e.length;s++)e[s]==0?o():(t.push(e[s]),i+=1,i==255&&o());return o(!1),t.push(0),Uint8Array.from(t)}function J(e){for(var t=[],r=0;r<e.length;){for(var i=e[r++],o=1;o<i;o++)t.push(e[r++]);i<255&&r<e.length&&t.push(0)}return Uint8Array.from(t)}const tt=10;async function nt(e){const t=await et(e),r={},i={};let o=0;setInterval(()=>{let c=[];for(;t.available();){const h=t.read();if(c.push(h),h===tt){const d=z(c);if(d.msg==="ack"){const u=i[d.msgCount];u(d.payload),console.log("resolved",d)}else if(d.msg in r){r[d.msg](d.payload);const u=_("ack",new Uint8Array(0),d.msgCount),f=G(u);t.write(f)}else{const u=String.fromCharCode.apply(null,c);console.log("unknown msg:",{msg:c,msgString:u})}c=[]}}},0);function s(c,h){r[c]=h}function a(c,h){let d=_(c,h,o);d=G(d);const u=new Promise((f,k)=>{const $=setTimeout(()=>{console.log("No response received for msg:",o),f()},5e3);i[o]=()=>{clearTimeout($),f()}});return console.log("sending",{msg:c,payload:h,msgCount:o,packedMsg:d,decoded:J(d),unpacked:z(J(d))}),t.write(d),o=(o+1)%9,u}async function l(){await t.close()}return{on:s,send:a,close:l}}function _(e,t,r){const i=[];return e.length>255&&console.error("msg too long"),i.push(e.length),e.split("").forEach(o=>i.push(o.charCodeAt(0))),e.length>255&&console.error("payload too long"),i.push(t.length),t.forEach(o=>i.push(o)),i.push(r),new Uint8Array(i)}function z(e){let t=0;const r=e[t++],i=[];for(;t<1+r;)i.push(e[t]),t++;const o=e[t++],s=[];for(;t<1+r+1+o;)s.push(e[t]),t++;const a=e[t++];return{msg:String.fromCharCode.apply(null,i),payload:s,msgCount:a}}function rt(e){var t=new Float32Array(e),r=new ArrayBuffer(t.byteLength);new Float32Array(r).set(t);var i=new Uint8Array(r);return i}function it(e){var t=new Uint32Array(e),r=new ArrayBuffer(t.byteLength);new Uint32Array(r).set(t);var i=new Uint8Array(r);return i}async function K(e){const t=await nt(e);async function r(o,s){const a=rt([o,s]);await t.send("go",a)}async function i(o){const s=it([o]);await t.send("servo",s)}return{port:t,goto:r,servo:i}}function ot(){let e;const t=R(document.body);t("click",".connect-trigger",async()=>{navigator.serial||alert("Your browser doesn't seem to support the Web Serial API,which is required for the Haxidraw editor to connect to the machine.Chrome Version 89 or above is the recommended browser."),e?(console.log("disconnecting"),await e.port.close(),e=null,E({connected:!1})):navigator.serial.requestPort({filters:[]}).then(async i=>{console.log("connecting"),e=await K(i),console.log(e),E({connected:!0})}).catch(i=>{})}),t("click",".run-machine-trigger",()=>{const{turtles:i}=b(),o=()=>st(e,i);O().then(()=>{if(!e){console.log("not connected");return}o()})});async function r(){(await navigator.serial.getPorts()).forEach(async o=>{o.getInfo().usbVendorId===11914&&(e=await K(o),console.log(e),E({connected:!0}))})}r()}const H=e=>new Promise(t=>setTimeout(t,e));async function st(e,t){await e.servo(1e3),await H(200);const r=t.map(i=>i.path).flat();for(const i of r)for(let o=0;o<i.length;o++){const[s,a]=i[o];o===0?(await e.servo(1e3),await H(200)):o===1&&(await e.servo(1700),await H(100)),await e.goto(s,a)}await e.servo(1e3),await H(200),await e.goto(0,0)}function at(){console.log("init"),ot()}function gt(){const[e,t]=A(50);return w(()=>{at(),ct(t)},[]),n(D,{children:[n(xe,{})," ",n(_e,{}),n("div",{class:P.root,children:[n(Re,{}),n("div",{class:P.inner,children:[n("div",{style:{width:`${e}%`},children:n(Qe,{})}),n("div",{class:`${P.vertBar} resize-trigger`,style:{left:`${e}%`}}),n("div",{class:P.right,style:{width:`${100-e}%`},children:[n(Ae,{}),n(Je,{}),n(qe,{})]})]})]}),n(Le,{}),n(ze,{})]})}function ct(e){const t=R(document.body);let r=!1,i=null;t("mousedown",".resize-trigger",o=>{r=!0,i=o.target,i!==null&&(i.style.width="8px",i.style.background="black")}),t("mousemove","",o=>{if(r){o.preventDefault();let s=o.clientX/window.innerWidth*100;s=Math.min(s,100),s=Math.max(s,0),e(s)}}),t("mouseup","",()=>{i!==null&&(i.style.width="",i.style.background=""),r=!1,i=null}),document.addEventListener("mouseleave",()=>{i!==null&&(i.style.width="",i.style.background=""),r=!1,i=null})}export{gt as default};
